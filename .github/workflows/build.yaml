name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install requirements
        run: |
          sudo apt install -y build-essential cmake libgmp-dev libsodium-dev nasm curl m4 git wget unzip nlohmann-json3-dev

      - name: Install Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run Anvil
        run: |
          /home/runner/.foundry/bin/anvil --mnemonic "myth like bonus scare over problem client lizard pioneer submit female collect" &

      - name: Deploy on Anvil
        run: |
          . ~/.bashrc && sleep 5 && git clone https://github.com/worm-privacy/worm && cd worm && /home/runner/.foundry/bin/forge create --rpc-url http://127.0.0.1:8545 src/BETH.sol:BETH --private-key 0x4f3edf983ac636a65a842ce7c78d9aa706d3b113bce9c46f30d7d21715b23b1d --broadcast    
      
      - name: Install miner
        run: |
          . ~/.bashrc && cargo install --path .
        
      - name: Download params
        run: |
          make download_params